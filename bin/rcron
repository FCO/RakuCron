#!/usr/bin/env raku

use App::RakuCron;
use App::RakuCron::Rules;
use Lumberjack;

subset File of Str where *.IO.f;

PROCESS::<$running> = False;
multi MAIN(Str :$e) {
    my $code = "use App::RakuCron; config \{ $e \}";
    given single-config-run :$code -> App::RakuCron::Rules $rules {
        await run-start $rules
    }
}

multi MAIN(File $file) {
    my Promise $last;
    react {
        whenever config-run :$file, :watch -> App::RakuCron::Rules $rules {
            $*running = False;
            $last = run-start $rules, $last // Promise.kept;
        }
    }
}
