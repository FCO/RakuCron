#!/usr/bin/env raku

use App::RakuCron::Configuration;
use App::RakuCron::Rules;

subset File of Str where *.IO.f;

multi MAIN(File $file) {
    react {
        whenever config-run :$file -> App::RakuCron::Rules $rules {
            for $rules.next-datetimes -> DateTime $time {
                next if $time < DateTime.now;
                await Promise.at: $time.Instant;
                for $rules.jobs-should-run-at: $time {
                    next unless .delta-validations: $time;
                    .run($time)
                }
            }
        }
    }
}
